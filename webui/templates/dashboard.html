<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTTPMR - Security Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f6f8fb;
            color: #1f2937;
            min-height: 100vh;
            padding: 24px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        header { background: #ffffff; border-radius: 8px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 6px 16px rgba(16,24,40,0.06); }

        h1 { color: #111827; margin-bottom: 6px; font-size: 1.6rem; }
        .subtitle { color: #4b5563; font-size: 0.95rem; }

        .card { background: #fff; border-radius: 8px; padding: 18px; margin-bottom: 18px; box-shadow: 0 6px 18px rgba(16,24,40,0.04); }

        .card h2 { color: #111827; margin-bottom: 14px; font-size: 1.15rem; border-bottom: 1px solid #eef2f7; padding-bottom: 8px; }

        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 6px; color: #374151; font-weight: 600; font-size: 0.95rem; }

        input[type="text"], select { width: 100%; padding: 10px 12px; border: 1px solid #e6eef6; border-radius: 6px; font-size: 0.95rem; }
        input[type="text"]:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59,130,246,0.08); }

        input[type="file"] { padding: 8px 10px; }

        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }

        button, .btn { padding: 10px 18px; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: 700; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-secondary { background: #f3f4f6; color: #111827; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-primary:hover { filter: brightness(1.03); }

        .reports-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }

        .report-card { background: #fff; border-radius: 8px; padding: 14px; box-shadow: 0 6px 18px rgba(16,24,40,0.04); border-left: 4px solid #2563eb; }
        .report-title { font-weight: 700; color: #0f172a; margin-bottom: 8px; font-size: 0.95rem; }
        .report-meta { font-size: 0.85rem; color: #6b7280; margin-bottom: 8px; }
        .report-url { color: #2563eb; font-weight: 600; margin-bottom: 8px; }

        .severity-badge { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; }
        .severity-high { background: #fff4f4; color: #b91c1c; }
        .severity-low { background: #f0fdf4; color: #166534; }

        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-badge { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
        .logout-btn { background: #ef4444; color: white; padding: 8px 14px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .logout-btn:hover { background: #dc2626; }
        
        @media (max-width: 768px) { .two-column { grid-template-columns: 1fr; } .reports-grid { grid-template-columns: 1fr; } }
    </style>
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div>
                    <h1>üîç HTTPMR Security Scanner</h1>
                    <p class="subtitle">HTTP & Web Vulnerability Assessment Tool</p>
                </div>
                <div class="user-info">
                    <span class="user-badge">üë§ {{ username }}</span>
                    <form method="post" action="/logout" style="margin: 0;">
                        <button type="submit" class="logout-btn">Sign Out</button>
                    </form>
                </div>
            </div>
        </header>

        <div class="two-column">
            <!-- Left Column: Scan Controls -->
            <div>
                <div class="card">
                    <h2>üöÄ Start New Scan</h2>
                    <form id="scanForm">
                        <div class="form-group">
                            <label for="target">Target (host or URL)</label>
                            <input type="text" id="target" name="target" placeholder="example.com or https://example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="mode">Scan Mode</label>
                            <select id="mode" name="mode">
                                <option value="auto">Auto (Full Scan)</option>
                                <option value="wordpress">WordPress Only</option>
                                <option value="headers">Security Headers Only</option>
                                <option value="server">Server Detection Only</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">Start Scan</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>üì§ Upload Report</h2>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="file">Choose JSON Report</label>
                            <input type="file" id="file" name="file" accept="application/json" required />
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-secondary">Upload</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Recent Reports -->
            <div>
                <div class="card">
                    <h2>üìã Recent Reports</h2>
                    {% if reports %}
                        <div style="max-height: 600px; overflow-y: auto;">
                            {% for item in reports[:5] %}
                                <div style="padding: 12px 0; border-bottom: 1px solid #eee;">
                                    <div class="report-title">{{ item.filename }}</div>
                                    {% if item.summary.url %}
                                        <div class="report-url">{{ item.summary.url }}</div>
                                    {% endif %}
                                    {% if item.summary.vuln_count %}
                                        <span class="severity-badge severity-high">{{ item.summary.vuln_count }} Vulnerabilities</span>
                                    {% else %}
                                        <span class="severity-badge severity-low">Clean</span>
                                    {% endif %}
                                    <div style="margin-top: 8px; font-size: 0.85em; color: #999;">{{ item.summary.timestamp }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No reports yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- All Reports Section -->
        <div class="card">
            <h2>üìä All Reports</h2>
            {% if reports %}
                <div class="reports-grid">
                    {% for item in reports %}
                        <div class="report-card">
                            <div class="report-title">{{ item.filename }}</div>
                            {% if item.summary.url %}
                                <div class="report-url">{{ item.summary.url }}</div>
                            {% endif %}
                            {% if item.summary.timestamp %}
                                <div class="report-meta">üìÖ {{ item.summary.timestamp }}</div>
                            {% endif %}
                            {% if item.summary.vuln_count %}
                                <span class="severity-badge severity-high">{{ item.summary.vuln_count }} Vulns</span>
                            {% else %}
                                <span class="severity-badge severity-low">Clean</span>
                            {% endif %}
                            {% if item.summary.security_score %}
                                <span class="severity-badge" style="background: #f3e5f5; color: #6a1b9a;">Score: {{ item.summary.security_score }}</span>
                            {% endif %}
                            <div class="report-actions">
                                <a href="/view?name={{ item.filename }}" class="btn btn-primary">View</a>
                                <button class="btn btn-success" onclick="convertSarif('{{ item.filename }}')">SARIF</button>
                                <button class="btn btn-danger" onclick="deleteReport('{{ item.filename }}')">Delete</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No reports found. Start a scan or upload one to get started!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        const scanForm = document.getElementById('scanForm');
        const uploadForm = document.getElementById('uploadForm');

        scanForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(scanForm);
            try {
                const res = await fetch('/run', {method:'POST', body: fd});
                const data = await res.json();
                if(data.job_id) {
                    window.location = '/run/' + data.job_id;
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch(e) {
                alert('Failed to start scan: ' + e.message);
            }
        });

        uploadForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(uploadForm);
            try {
                const res = await fetch('/upload', {method:'POST', body: fd});
                if(res.redirected) {
                    window.location = res.url;
                } else {
                    alert('Upload failed');
                }
            } catch(e) {
                alert('Failed to upload: ' + e.message);
            }
        });

        function deleteReport(filename) {
            if(!confirm('Are you sure you want to delete ' + filename + '?')) return;
            const fd = new FormData();
            fd.append('name', filename);
            fetch('/delete_report', {method:'POST', body: fd})
                .then(r => r.json())
                .then(data => {
                    if(data.status === 'deleted') {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                    }
                })
                .catch(e => alert('Delete failed: ' + e.message));
        }

        function convertSarif(filename) {
            const fd = new FormData();
            fd.append('name', filename);
            fetch('/convert_sarif', {method:'POST', body: fd})
                .then(r => r.json())
                .then(data => {
                    if(data.status === 'converted') {
                        alert('SARIF conversion successful! You can download it now.');
                        const a = document.createElement('a');
                        a.href = '/download_sarif?name=' + encodeURIComponent(filename);
                        a.click();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                    }
                })
                .catch(e => alert('Conversion failed: ' + e.message));
        }
    </script>
</body>
</html>
